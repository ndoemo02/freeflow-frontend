// freeflow-assistant.js
// ----------------------------------------------------------
// Mowa â†’ szukanie â†’ krÃ³tka odpowiedÅº + TTS (UPDATED)
// ----------------------------------------------------------

const $  = (s) => document.querySelector(s);
const app        = $('#app');
const transcript = $('#transcript');
const micBtn     = $('#micBtn');
const logoBtn    = $('#logoBtn');
const dot        = $('#dot');
const banner     = $('#banner');
const tileFood   = $('#tileFood');
const tileTaxi   = $('#tileTaxi');
const tileHotel  = $('#tileHotel');

// Nowe elementy UI do wynikÃ³w
const resultsContainer = $('#resultsContainer');
const resultsList = $('#resultsList');
const clearResults = $('#clearResults');

const GMAPS_PROXY = (document.querySelector('meta[name="gmaps-proxy"]')?.content || '/api/places').trim();
const GPT_PROXY   = (document.querySelector('meta[name="gpt-proxy"]')?.content   || '/api/gpt').trim();
const TTS_PROXY   = '/api/tts';

// ---------- UI helpers ----------
function showBanner(msg, type = 'info') {
  banner.textContent = msg;
  banner.classList.remove('hidden');
  banner.style.background = type === 'err'
    ? 'rgba(255,72,72,.15)'
    : type === 'warn'
    ? 'rgba(255,203,72,.15)'
    : 'rgba(72,179,255,.12)';
  banner.style.color = type === 'err' ? '#ffd1d1' : type === 'warn' ? '#ffe6a3' : '#dff1ff';
}
function hideBanner() { banner.classList.add('hidden'); banner.textContent=''; }

// Funkcje do wyÅ›wietlania wynikÃ³w
function showResults(results, query) {
  console.log('[FreeFlow] WyÅ›wietlam wyniki:', results);
  console.log('[FreeFlow] Zapytanie:', query);
  
  if (!results || results.length === 0) {
    hideResults();
    return;
  }
  
  resultsList.innerHTML = '';
  
  results.forEach((result, index) => {
    console.log(`[FreeFlow] Wynik ${index + 1}:`, {
      name: result.name,
      rating: result.rating,
      votes: result.votes,
      address: result.address
    });
    
    const item = document.createElement('div');
    item.className = 'result-item';
    
    // Ikona zaleÅ¼nie od kategorii
    const category = query?.category || 'restaurant';
    const iconEmoji = category.includes('pizza') ? 'ğŸ•' : 
                     category.includes('taxi') ? 'ğŸš•' : 
                     category.includes('hotel') ? 'ğŸ¨' : 'ğŸ½ï¸';
    
    item.innerHTML = `
      <div class="result-icon">${iconEmoji}</div>
      <div class="result-details">
        <div class="result-name">${result.name}</div>
        <div class="result-meta">
          <div class="result-rating">
            <span>â˜…</span>
            <span>${result.rating.toFixed(1)}</span>
            <span>(${result.votes})</span>
          </div>
        </div>
        <div class="result-address">${result.address}</div>
      </div>
    `;
    
    resultsList.appendChild(item);
  });
  
  resultsContainer.classList.remove('hidden');
  console.log('[FreeFlow] Kontener wynikÃ³w pokazany');
}

function hideResults() {
  console.log('[FreeFlow] Ukrywam wyniki');
  resultsContainer.classList.add('hidden');
  resultsList.innerHTML = '';
}

function logDebug(message, data) {
  console.log(`[FreeFlow Debug] ${message}`, data || '');
}

function setGhostText(msg){ transcript.classList.add('ghost'); transcript.textContent = msg; }
function setFinalText(msg){ transcript.classList.remove('ghost'); transcript.textContent = msg; }
function setListening(on){
  document.body.classList.toggle('listening', !!on);
  dot.style.boxShadow = on ? '0 0 18px #86e2ff' : '0 0 0 #0000';
}

// ---------- Geo ----------
async function getPositionOrNull(timeoutMs = 6000) {
  if (!('geolocation' in navigator)) {
    showBanner('Twoja przeglÄ…darka nie obsÅ‚uguje lokalizacji.', 'warn');
    return null;
  }
  const p = () => new Promise((resolve, reject) => {
    navigator.geolocation.getCurrentPosition(
      (pos)=>resolve(pos.coords),
      (err)=>reject(err),
      { enableHighAccuracy:true, timeout:timeoutMs, maximumAge:25000 }
    );
  });
  try { const c = await p(); hideBanner(); return c; }
  catch(e){
    const map={1:'Brak zgody na lokalizacjÄ™.',2:'Lokalizacja niedostÄ™pna.',3:'Przekroczono czas oczekiwania.'};
    showBanner(`${map[e.code] ?? 'BÅ‚Ä…d lokalizacji.'} â€” szukam po tekÅ›cie.`, 'warn');
    return null;
  }
}

// ---------- NLP (rozszerzona obsÅ‚uga polskich nazw miejscowoÅ›ci) ----------
function extractQuery(text){
  const t = (text||'').trim();

  // Kategoria
  const catRe = /(pizzeria|pizze|pizza|restauracja|restauracje|kebab|sushi|hotel|nocleg|taxi)/i;
  const mCat = t.match(catRe);
  if(!mCat) return null;

  const base = (mCat[1]||'').toLowerCase();
  const category =
    /restaurac/.test(base) ? 'restauracje' :
    /pizz/.test(base)      ? 'pizzeria'    :
    /(hotel|nocleg)/.test(base) ? 'hotel'  :
    /taxi/.test(base)      ? 'taxi'        : base;

  // Miasto po przyimku (w|we|na), 1â€“3 wyrazy z wielkiej litery
  const locRe = /\b(w|we|na)\s+([A-ZÄ„Ä†Ä˜ÅÅƒÃ“ÅšÅ¹Å»][\w\-''Ä…Ä‡Ä™Å‚Å„Ã³Å›ÅºÅ¼]+(?:\s+[A-ZÄ„Ä†Ä˜ÅÅƒÃ“ÅšÅ¹Å»][\w\-''Ä…Ä‡Ä™Å‚Å„Ã³Å›ÅºÅ¼]+){0,2})\b/iu;
  const mLoc = t.match(locRe);

  let cityRaw = mLoc ? mLoc[2].trim() : null;
  const city = cityRaw ? toNominative(cityRaw) : null;

  return { category, cityRaw, city };
}

function toNominative(name){
  const parts = name.split(/\s+/);
  const norm = parts.map(p => deinflectToken(p)).join(' ');
  return norm;
}

// heurystyka â€miejscownik â†’ mianownik" dla popularnych koÅ„cÃ³wek
function deinflectToken(w){
  const src = w;
  // czÄ™sto nie odmieniaÄ‡:
  if(/^(ZdrÃ³j|Wlkp\.?|ÅšlÄ…skie|MaÅ‚opolskie|Pomorskie|Kujawsko-Pomorskie)$/iu.test(src)) return src;

  const rules = [
    [/([b-df-hj-np-tv-zÄ…Ä‡Ä™Å‚Å„Ã³Å›ÅºÅ¼])u$/iu, '$1'],       // GdaÅ„sku â†’ GdaÅ„sk
    [/awie$/iu, 'awa'],                               // Warszawie â†’ Warszawa
    [/owie$/iu, 'owo'],                               // WÅ‚adysÅ‚awowie â†’ WÅ‚adysÅ‚awowo
    [/kowie$/iu, 'kÃ³w'],                              // Krakowie â†’ KrakÃ³w
    [/ach$/iu, 'y'],                                  // Piekarach â†’ Piekary
    [/skich$/iu, 'skie'],                             // ÅšlÄ…skich â†’ ÅšlÄ…skie
    [/olu$/iu, 'ole'],                                // Opolu â†’ Opole
    [/dzi$/iu, 'dÅº'],                                 // Åodzi â†’ ÅÃ³dÅº
    [/owie$/iu, 'Ã³w'],                                // Rzeszowie â†’ RzeszÃ³w
  ];
  let out = src;
  for (const [re, rep] of rules){
    if (re.test(out)){ out = out.replace(re, rep); break; }
  }
  return out;
}

// ---------- API helpers ----------
async function callPlaces(params){
  const sp=new URLSearchParams();
  if(params.query) sp.set('query', params.query);
  if(params.lat)   sp.set('lat', params.lat);
  if(params.lng)   sp.set('lng', params.lng);
  if(params.radius)sp.set('radius', params.radius);
  if(params.rankby)sp.set('rankby', params.rankby);
  if(params.keyword)sp.set('keyword', params.keyword);
  if(params.n)     sp.set('n', params.n);
  sp.set('language', params.language || 'pl');
  const res=await fetch(`${GMAPS_PROXY}?${sp.toString()}`,{method:'GET'});
  if(!res.ok) throw new Error(`Places HTTP ${res.status}`);
  return res.json();
}

async function callGPTSummary(userText, results){
  // JeÅ¼eli backend GPT jest w trybie â€echo", nie uÅ¼ywamy odpowiedzi do UI, tylko TTS i tak jÄ… przykryje.
  try{
    const prompt =
      `Odpowiedz jednym krÃ³tkim zdaniem po polsku (max 25 sÅ‚Ã³w), bez cytowania uÅ¼ytkownika i bez wstÄ™pÃ³w. `+
      `UÅ¼yj danych: ${results.map(r=>`${r.name} (${r.rating}â˜…)`).join('; ')}. `+
      `ZakoÅ„cz: "Skorzystaj z aplikacji FreeFlow, aby zamÃ³wiÄ‡ szybko i wygodnie!"`;
    const res=await fetch(GPT_PROXY,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt})});
    if(!res.ok) throw new Error('GPT HTTP '+res.status);
    const j=await res.json();
    const raw=(j.reply||'').trim();
    return raw.replace(/^echo:\s*/i,'').replace(/^uÅ¼ytkownik.*?:/i,'').trim();
  }catch{ return ''; }
}

async function speakTTS(text, voice='alloy'){
  if(!text) return;
  try{
    const res=await fetch(TTS_PROXY,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text,voice})});
    if(!res.ok) throw new Error('TTS HTTP '+res.status);
    const blob=await res.blob();
    const url=URL.createObjectURL(blob);
    const audio=new Audio(url);
    audio.play();
  }catch(e){
    // Fallback: Web Speech API (moÅ¼e kaleczyÄ‡ przecinki)
    try{
      const u=new SpeechSynthesisUtterance(text);
      u.lang='pl-PL';
      speechSynthesis.speak(u);
    }catch{}
  }
}

// ---------- GÅ‚Ã³wna Å›cieÅ¼ka (ZAKTUALIZOWANA LOGIKA) ----------
async function handleUserQuery(userText){
  try{
    setFinalText(userText);

    const q = extractQuery(userText);
    const coords = (!q || !q.city) ? await getPositionOrNull(6000) : null;

    const params = { language:'pl', n:2 };

    if (q && q.city){
      // wyszukiwanie tekstowe po mieÅ›cie (bez GPS)
      params.query = `${q.category} w ${q.city}`;
    } else if (coords){
      params.lat    = coords.latitude.toFixed(6);
      params.lng    = coords.longitude.toFixed(6);
      params.radius = 5000;
      if(q) params.keyword = q.category;
    } else if (q){
      params.query = q.category;
    } else {
      showBanner('Powiedz np. â€pizzeria we WÅ‚adysÅ‚awowie".','warn');
      await speakTTS('Powiedz na przykÅ‚ad: pizzeria we WÅ‚adysÅ‚awowie.');
      return;
    }

    // KrÃ³tki komunikat statusu
    showBanner('Szukam miejscâ€¦');

    const data = await callPlaces(params);

    const list = (data?.results || data || [])
      .filter(x => x && (x.rating ?? null) !== null)
      .map(x => ({
        name: x.name,
        rating: Number(x.rating || 0),
        votes: Number(x.user_ratings_total || 0),
        address: (x.formatted_address || x.vicinity || 'â€”')
      }))
      .sort((a,b)=>(b.rating-a.rating)||(b.votes-a.votes));

    const results = list.slice(0,2);
    if(!results.length){
      showBanner('Nic nie znalazÅ‚em. SprÃ³buj innÄ… frazÄ™.', 'warn');
      return;
    }

    // KrÃ³tki baner z wynikiem (bez â€UÅ¼ytkownik prosiÅ‚â€¦")
    if(results.length===1){
      const a=results[0];
      showBanner(`Najlepsze w pobliÅ¼u: ${a.name} (${a.rating}â˜…).`);
    }else{
      const [a,b]=results;
      showBanner(`Top 2: ${a.name} (${a.rating}â˜…), ${b.name} (${b.rating}â˜…).`);
    }

    // Zbuduj zwiÄ™zÅ‚y tekst do TTS (nie pokazujemy go w ramce)
    let summary = await callGPTSummary(userText, results);
    if(!summary){
      // Fallback bez GPT
      summary = results.length===1
        ? `Polecam ${results[0].name}, ocena ${results[0].rating.toString().replace('.',',')} gwiazdki. Skorzystaj z aplikacji FreeFlow, aby zamÃ³wiÄ‡ szybko i wygodnie!`
        : `Polecam ${results[0].name} i ${results[1].name}, odpowiednio ${results[0].rating.toString().replace('.',',')} i ${results[1].rating.toString().replace('.',',')} gwiazdki. Skorzystaj z aplikacji FreeFlow, aby zamÃ³wiÄ‡ szybko i wygodnie!`;
    }

    // MÃ³wimy
    speakTTS(summary, 'aria'); // â€aria" zwykle Å‚adniej czyta PL

  }catch(e){
    console.error(e);
    showBanner('Ups, coÅ› poszÅ‚o nie tak. SprÃ³buj ponownie.', 'err');
  }
}

// ---------- ASR ----------
let recognition=null, listening=false;

function initASR(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR) return null;
  const rec=new SR();
  rec.lang='pl-PL'; rec.interimResults=true; rec.maxAlternatives=1;

  rec.onstart=()=>{ listening=true; setListening(true); setGhostText('SÅ‚uchamâ€¦'); };
  rec.onerror=(e)=>{ console.warn('ASR error',e); showBanner('BÅ‚Ä…d rozpoznawania mowy.', 'warn'); };
  rec.onresult=(ev)=>{
    let interim='', final='';
    for(let i=ev.resultIndex;i<ev.results.length;i++){
      const chunk=ev.results[i][0].transcript;
      if(ev.results[i].isFinal) final+=chunk; else interim+=chunk;
    }
    if(final){
      setFinalText(final.trim());
      try{ rec.stop(); }catch{}
      listening=false; setListening(false);
      handleUserQuery(final.trim());
    }else if(interim){ setGhostText(interim.trim()); }
  };
  rec.onend=()=>{
    listening=false; setListening(false);
    if(!transcript.textContent || transcript.classList.contains('ghost')){
      setGhostText('Powiedz, co chcesz zamÃ³wiÄ‡â€¦');
    }
  };
  return rec;
}

function toggleMic(){
  if(!recognition){
    const typed=prompt('Rozpoznawanie mowy niedostÄ™pne. Wpisz, co chcesz zamÃ³wiÄ‡:');
    if(typed?.trim()){ setFinalText(typed.trim()); handleUserQuery(typed.trim()); }
    return;
  }
  if(listening){ try{recognition.stop();}catch{} }
  else{
    try{ recognition.start(); }
    catch(e){
      const typed=prompt('Nie udaÅ‚o siÄ™ wÅ‚Ä…czyÄ‡ mikrofonu. Wpisz, co chcesz zamÃ³wiÄ‡:');
      if(typed?.trim()){ setFinalText(typed.trim()); handleUserQuery(typed.trim()); }
    }
  }
}

// ---------- UI ----------
function bindUI(){
  micBtn?.addEventListener('click', toggleMic);
  logoBtn?.addEventListener('click', toggleMic);
  const activate=(btn)=>[tileFood,tileTaxi,tileHotel].forEach(b=>b?.classList.toggle('active', b===btn));
  tileFood?.addEventListener('click',()=>activate(tileFood));
  tileTaxi?.addEventListener('click',()=>activate(tileTaxi));
  tileHotel?.addEventListener('click',()=>activate(tileHotel));
  setGhostText('Powiedz, co chcesz zamÃ³wiÄ‡â€¦');
}

// ---------- start ----------
(function(){
  recognition=initASR();
  bindUI();
  // miÄ™kkie â€rozgrzanie" geo
  getPositionOrNull(3000).then(()=>{ /*no-op*/ });
})();
