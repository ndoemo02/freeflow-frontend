<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>FreeFlow STT Test</title>
  <style>
    body { 
      font-family: sans-serif; 
      background: #0b0b0b; 
      color: #eee; 
      text-align: center; 
      padding-top: 80px; 
      margin: 0;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
    }
    #transcript { 
      margin-top: 20px; 
      font-size: 1.2em; 
      color: #0f0; 
      min-height: 50px;
      padding: 20px;
      background: #1a1a1a;
      border-radius: 10px;
      border: 1px solid #333;
    }
    button { 
      background: #333; 
      color: #fff; 
      padding: 15px 30px; 
      border: none; 
      border-radius: 10px; 
      cursor: pointer; 
      font-size: 16px;
      margin: 10px;
    }
    button:hover { background: #555; }
    button:active { background: #777; }
    .status {
      margin-top: 20px;
      padding: 10px;
      border-radius: 5px;
    }
    .success { background: #0a4a0a; color: #0f0; }
    .error { background: #4a0a0a; color: #f00; }
    .info { background: #0a0a4a; color: #00f; }
    .history {
      margin-top: 30px;
      text-align: left;
      background: #1a1a1a;
      padding: 20px;
      border-radius: 10px;
      border: 1px solid #333;
    }
    .history h3 { margin-top: 0; }
    .history-item {
      padding: 10px;
      margin: 5px 0;
      background: #2a2a2a;
      border-radius: 5px;
      border-left: 3px solid #0f0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üé§ FreeFlow STT Web Test</h1>
    <p>Test rozpoznawania mowy i integracji z systemem zam√≥wie≈Ñ</p>
    
    <button id="start">üéôÔ∏è Start nagrywania</button>
    <button id="clear">üóëÔ∏è Wyczy≈õƒá</button>
    
    <div id="transcript">Kliknij "Start nagrywania" i m√≥w...</div>
    
    <div id="status"></div>
    
    <div class="history">
      <h3>üìù Historia komend:</h3>
      <div id="history"></div>
    </div>
  </div>

  <script>
    const startBtn = document.getElementById("start");
    const transcriptEl = document.getElementById("transcript");
    const statusEl = document.getElementById("status");
    const historyEl = document.getElementById("history");
    const clearBtn = document.getElementById("clear");
    
    let recognizing = false;
    let recognition;
    let history = [];

    // Sprawd≈∫ obs≈Çugƒô STT
    if (!("webkitSpeechRecognition" in window) && !("SpeechRecognition" in window)) {
      showStatus("Twoja przeglƒÖdarka nie obs≈Çuguje SpeechRecognition üò¢ U≈ºyj Chrome lub Edge", "error");
    } else {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = "pl-PL";
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.maxAlternatives = 1;

      recognition.onstart = () => {
        showStatus("üé§ Nagrywanie rozpoczƒôte...", "info");
        startBtn.textContent = "üõë Stop nagrywania";
        recognizing = true;
      };

      recognition.onresult = async (event) => {
        let interimText = "";
        let finalText = "";

        for (let i = event.resultIndex; i < event.results.length; i++) {
          const result = event.results[i];
          if (result.isFinal) {
            finalText += result[0].transcript;
          } else {
            interimText += result[0].transcript;
          }
        }

        // Poka≈º tekst na ≈ºywo
        transcriptEl.textContent = finalText + (interimText ? " " + interimText : "");

        // Je≈õli mamy finalny tekst, wy≈õlij do backendu
        if (finalText.trim()) {
          console.log("Final STT:", finalText);
          await processVoiceCommand(finalText.trim());
        }
      };

      recognition.onerror = (e) => {
        console.error("B≈ÇƒÖd STT:", e.error);
        showStatus(`B≈ÇƒÖd STT: ${e.error}`, "error");
        recognizing = false;
        startBtn.textContent = "üéôÔ∏è Start nagrywania";
      };

      recognition.onend = () => {
        recognizing = false;
        startBtn.textContent = "üéôÔ∏è Start nagrywania";
        showStatus("Nagrywanie zako≈Ñczone", "info");
      };

      startBtn.onclick = () => {
        if (recognizing) {
          recognition.stop();
        } else {
          recognition.start();
        }
      };
    }

    clearBtn.onclick = () => {
      transcriptEl.textContent = "Kliknij 'Start nagrywania' i m√≥w...";
      history = [];
      historyEl.innerHTML = "";
      showStatus("Historia wyczyszczona", "info");
    };

    async function processVoiceCommand(message) {
      try {
        showStatus("üîÑ Przetwarzanie komendy...", "info");
        
        // Dodaj do historii
        addToHistory(message, "user");
        
        // Wy≈õlij do backendu (u≈ºywamy istniejƒÖcego endpointu)
        const response = await fetch("/api/dialogflow-freeflow", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            fulfillmentInfo: { tag: "voice_command" },
            sessionInfo: { 
              parameters: { 
                user_message: message,
                user_email: "test@freeflow.ai"
              } 
            }
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        console.log("Backend response:", data);
        
        const responseText = data.fulfillment_response?.messages?.[0]?.text?.text?.[0] || "Brak odpowiedzi";
        
        showStatus("‚úÖ Komenda przetworzona", "success");
        addToHistory(responseText, "assistant");
        
        // Wyczy≈õƒá pole tekstowe
        transcriptEl.textContent = "Kliknij 'Start nagrywania' i m√≥w...";
        
      } catch (error) {
        console.error("Error processing voice command:", error);
        showStatus(`‚ùå B≈ÇƒÖd: ${error.message}`, "error");
        addToHistory(`B≈ÇƒÖd: ${error.message}`, "error");
      }
    }

    function showStatus(message, type) {
      statusEl.textContent = message;
      statusEl.className = `status ${type}`;
      
      // Ukryj status po 3 sekundach
      setTimeout(() => {
        statusEl.textContent = "";
        statusEl.className = "";
      }, 3000);
    }

    function addToHistory(message, type) {
      const item = document.createElement("div");
      item.className = "history-item";
      
      const timestamp = new Date().toLocaleTimeString();
      const icon = type === "user" ? "üë§" : type === "assistant" ? "ü§ñ" : "‚ùå";
      
      item.innerHTML = `
        <strong>${icon} ${type === "user" ? "Ty" : type === "assistant" ? "Asystent" : "B≈ÇƒÖd"}</strong> 
        <small>(${timestamp})</small><br>
        ${message}
      `;
      
      historyEl.insertBefore(item, historyEl.firstChild);
      history.push({ message, type, timestamp });
    }
  </script>
</body>
</html>
