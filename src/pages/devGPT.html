<!doctype html>
<html lang="pl" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel Analityczny Administratora</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg0:#070A12;
      --bg1:#0B1222;
      --fg0:#EAF0FF;
      --muted:#9AA7C2;
      --border:rgba(255,255,255,.10);
      --glass:rgba(255,255,255,.06);
      --glass2:rgba(255,255,255,.09);
      --shadow:0 10px 35px rgba(0,0,0,.35);
      --neon:#5B7CFF;
      --neon2:#38BDF8;
      --good:#22C55E;
      --warn:#F59E0B;
      --bad:#EF4444;
    }
    html:not(.dark){
      --bg0:#F6F8FF;
      --bg1:#EEF2FF;
      --fg0:#0A1020;
      --muted:#54607A;
      --border:rgba(10,16,32,.12);
      --glass:rgba(255,255,255,.65);
      --glass2:rgba(255,255,255,.78);
      --shadow:0 14px 30px rgba(10,16,32,.10);
      --neon:#2F5BFF;
      --neon2:#0891B2;
    }
    body{
      color:var(--fg0);
      background:
        radial-gradient(1100px 700px at 20% 10%, rgba(91,124,255,.18), transparent 60%),
        radial-gradient(900px 600px at 85% 20%, rgba(56,189,248,.16), transparent 55%),
        radial-gradient(700px 500px at 55% 85%, rgba(139,92,246,.12), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
    }
    .grid-overlay{
      position:fixed; inset:0; pointer-events:none; opacity:.45; mix-blend-mode:overlay;
      background-image:
        linear-gradient(to right, rgba(255,255,255,.045) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(255,255,255,.045) 1px, transparent 1px);
      background-size: 56px 56px;
      mask-image: radial-gradient(75% 60% at 50% 25%, black 30%, transparent 70%);
    }
    html:not(.dark) .grid-overlay{ opacity:.25; mix-blend-mode:multiply; }

    .glass{
      background:var(--glass);
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    .glass-strong{
      background:var(--glass2);
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    .neon-ring{
      box-shadow:
        0 0 0 1px rgba(91,124,255,.25),
        0 12px 28px rgba(0,0,0,.28),
        0 0 26px rgba(91,124,255,.10);
    }
    html:not(.dark) .neon-ring{
      box-shadow:
        0 0 0 1px rgba(47,91,255,.18),
        0 16px 30px rgba(10,16,32,.10),
        0 0 20px rgba(47,91,255,.10);
    }

    .fade-in{ animation: fadeIn .35s ease-out both; }
    @keyframes fadeIn{ from{ opacity:0; transform: translateY(6px);} to{ opacity:1; transform:none;} }

    .focus-ring:focus{ outline:none; box-shadow: 0 0 0 2px rgba(91,124,255,.25), 0 0 0 4px rgba(91,124,255,.18); }

    .tiny-scroll::-webkit-scrollbar{ height:10px; width:10px; }
    .tiny-scroll::-webkit-scrollbar-thumb{ background: rgba(148,163,184,.35); border-radius:999px; }
    .tiny-scroll::-webkit-scrollbar-track{ background: transparent; }

    @media (prefers-reduced-motion: reduce){
      .fade-in{ animation:none; }
      *{ scroll-behavior:auto !important; }
    }
  </style>
</head>
<body class="antialiased selection:bg-[rgba(91,124,255,.25)] selection:text-[var(--fg0)]">
  <div class="grid-overlay"></div>

  <div class="relative max-w-[1440px] mx-auto px-4 sm:px-6 lg:px-8 py-5">

    <!-- Top bar -->
    <header class="flex items-center justify-between gap-3">
      <div class="flex items-center gap-3 min-w-0">
        <div class="size-9 rounded-xl glass neon-ring flex items-center justify-center">
          <svg class="size-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M4 19V5" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
            <path d="M4 17H20" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
            <path d="M7 15V12" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
            <path d="M11 15V9" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
            <path d="M15 15V11" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
            <path d="M19 15V7" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="min-w-0">
          <div class="flex items-center gap-2 min-w-0">
            <h1 class="text-[15px] sm:text-base font-semibold tracking-tight truncate">Panel analityczny (Admin)</h1>
            <span id="envBadge" class="text-[11px] px-2 py-0.5 rounded-full glass border border-[var(--border)] text-[color:var(--muted)]">prod</span>
            <span id="clock" class="hidden sm:inline text-[11px] text-[color:var(--muted)]">—</span>
          </div>
          <p class="text-[12px] text-[color:var(--muted)] leading-4 truncate">Metryki operacyjne • wykresy + logi • kompaktowy panel do codziennej pracy</p>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <div class="hidden md:flex items-center gap-2 glass rounded-xl px-2 py-1 border border-[var(--border)]">
          <span class="text-[11px] text-[color:var(--muted)]">Zakres</span>
          <select id="range" class="bg-transparent text-[12px] font-medium focus-ring rounded-lg px-2 py-1">
            <option value="24h" selected>Ostatnie 24h</option>
            <option value="6h">Ostatnie 6h</option>
            <option value="1h">Ostatnia 1h</option>
          </select>
        </div>

        <button id="refresh" class="glass rounded-xl px-3 py-2 text-[12px] font-medium border border-[var(--border)] hover:neon-ring transition-shadow focus-ring" aria-label="Odśwież">
          <span class="inline-flex items-center gap-2">
            <svg class="size-4" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M20 12a8 8 0 1 1-2.34-5.66" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
              <path d="M20 4v6h-6" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Odśwież
          </span>
        </button>

        <button id="themeToggle" class="glass rounded-xl px-3 py-2 text-[12px] font-medium border border-[var(--border)] hover:neon-ring transition-shadow focus-ring" aria-label="Przełącz motyw">
          <span class="inline-flex items-center gap-2">
            <svg id="themeIcon" class="size-4" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M21 12.6A8.4 8.4 0 1 1 11.4 3a6.6 6.6 0 1 0 9.6 9.6Z" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span id="themeLabel">Ciemny</span>
          </span>
        </button>
      </div>
    </header>

    <!-- KPIs -->
    <section class="mt-4">
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-2">

        <div class="glass rounded-xl px-3 py-2.5 border border-[var(--border)] hover:neon-ring transition-shadow fade-in">
          <div class="flex items-center justify-between gap-2">
            <div class="flex items-center gap-2 min-w-0">
              <div class="size-8 rounded-lg glass-strong flex items-center justify-center border border-[var(--border)]">
                <svg class="size-4" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M4 7h16M4 12h16M4 17h16" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
                </svg>
              </div>
              <div class="min-w-0">
                <div class="text-[11px] text-[color:var(--muted)] leading-4">Łącznie żądań</div>
                <div id="kpiRequests" class="text-[16px] font-semibold tracking-tight">—</div>
              </div>
            </div>
            <div id="trendRequests" class="text-[11px] font-medium px-2 py-0.5 rounded-full border border-[var(--border)] glass">—</div>
          </div>
        </div>

        <div class="glass rounded-xl px-3 py-2.5 border border-[var(--border)] hover:neon-ring transition-shadow fade-in" style="animation-delay: 40ms;">
          <div class="flex items-center justify-between gap-2">
            <div class="flex items-center gap-2 min-w-0">
              <div class="size-8 rounded-lg glass-strong flex items-center justify-center border border-[var(--border)]">
                <svg class="size-4" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M16 14a4 4 0 1 0-8 0" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
                  <path d="M12 12a3 3 0 1 0-3-3 3 3 0 0 0 3 3Z" stroke="currentColor" stroke-width="1.7"/>
                  <path d="M4 20c1.5-3.5 4.8-6 8-6s6.5 2.5 8 6" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
                </svg>
              </div>
              <div class="min-w-0">
                <div class="text-[11px] text-[color:var(--muted)] leading-4">Aktywne sesje</div>
                <div id="kpiSessions" class="text-[16px] font-semibold tracking-tight">—</div>
              </div>
            </div>
            <div id="trendSessions" class="text-[11px] font-medium px-2 py-0.5 rounded-full border border-[var(--border)] glass">—</div>
          </div>
        </div>

        <div class="glass rounded-xl px-3 py-2.5 border border-[var(--border)] hover:neon-ring transition-shadow fade-in" style="animation-delay: 80ms;">
          <div class="flex items-center justify-between gap-2">
            <div class="flex items-center gap-2 min-w-0">
              <div class="size-8 rounded-lg glass-strong flex items-center justify-center border border-[var(--border)]">
                <svg class="size-4" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12 2v4" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
                  <path d="M12 18v4" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
                  <path d="M4.93 4.93 7.76 7.76" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
                  <path d="M16.24 16.24l2.83 2.83" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
                  <path d="M2 12h4" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
                  <path d="M18 12h4" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
                  <path d="M4.93 19.07 7.76 16.24" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
                  <path d="M16.24 7.76l2.83-2.83" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
                  <path d="M12 17a5 5 0 1 1 5-5" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
                </svg>
              </div>
              <div class="min-w-0">
                <div class="text-[11px] text-[color:var(--muted)] leading-4">Śr. opóźnienie (ms)</div>
                <div id="kpiLatency" class="text-[16px] font-semibold tracking-tight">—</div>
              </div>
            </div>
            <div id="trendLatency" class="text-[11px] font-medium px-2 py-0.5 rounded-full border border-[var(--border)] glass">—</div>
          </div>
        </div>

        <div class="glass rounded-xl px-3 py-2.5 border border-[var(--border)] hover:neon-ring transition-shadow fade-in" style="animation-delay: 120ms;">
          <div class="flex items-center justify-between gap-2">
            <div class="flex items-center gap-2 min-w-0">
              <div class="size-8 rounded-lg glass-strong flex items-center justify-center border border-[var(--border)]">
                <svg class="size-4" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12 9v4" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
                  <path d="M12 17h.01" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"/>
                  <path d="M10.29 3.86 2.82 17a2 2 0 0 0 1.71 3h14.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0Z" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </div>
              <div class="min-w-0">
                <div class="text-[11px] text-[color:var(--muted)] leading-4">Wskaźnik błędów (%)</div>
                <div id="kpiErrorRate" class="text-[16px] font-semibold tracking-tight">—</div>
              </div>
            </div>
            <div id="trendErrorRate" class="text-[11px] font-medium px-2 py-0.5 rounded-full border border-[var(--border)] glass">—</div>
          </div>
        </div>

        <div class="glass rounded-xl px-3 py-2.5 border border-[var(--border)] hover:neon-ring transition-shadow fade-in" style="animation-delay: 160ms;">
          <div class="flex items-center justify-between gap-2">
            <div class="flex items-center gap-2 min-w-0">
              <div class="size-8 rounded-lg glass-strong flex items-center justify-center border border-[var(--border)]">
                <svg class="size-4" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12 21a9 9 0 1 0-9-9" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
                  <path d="M3 12a9 9 0 0 0 9 9" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
                  <path d="M12 7v5l3 2" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </div>
              <div class="min-w-0">
                <div class="text-[11px] text-[color:var(--muted)] leading-4">Status systemu</div>
                <div class="flex items-center gap-2">
                  <span id="kpiStatus" class="text-[15px] font-semibold tracking-tight">—</span>
                  <span id="kpiStatusPill" class="text-[11px] px-2 py-0.5 rounded-full border border-[var(--border)] glass">—</span>
                </div>
              </div>
            </div>
            <div class="text-[11px] text-[color:var(--muted)]">SLO</div>
          </div>
        </div>

      </div>
    </section>

    <!-- Tabs -->
    <section class="mt-3">
      <div class="glass rounded-xl border border-[var(--border)] px-2 py-2 flex items-center justify-between gap-2">
        <div class="flex items-center gap-1" role="tablist" aria-label="Zakładki analityki">
          <button class="tab-btn focus-ring px-3 py-2 text-[12px] font-medium rounded-lg border border-transparent hover:border-[var(--border)] hover:bg-[rgba(255,255,255,.04)] transition" data-tab="overview" role="tab" aria-selected="true">Przegląd</button>
          <button class="tab-btn focus-ring px-3 py-2 text-[12px] font-medium rounded-lg border border-transparent hover:border-[var(--border)] hover:bg-[rgba(255,255,255,.04)] transition" data-tab="traffic" role="tab" aria-selected="false">Ruch</button>
          <button class="tab-btn focus-ring px-3 py-2 text-[12px] font-medium rounded-lg border border-transparent hover:border-[var(--border)] hover:bg-[rgba(255,255,255,.04)] transition" data-tab="latency" role="tab" aria-selected="false">Opóźnienia</button>
          <button class="tab-btn focus-ring px-3 py-2 text-[12px] font-medium rounded-lg border border-transparent hover:border-[var(--border)] hover:bg-[rgba(255,255,255,.04)] transition" data-tab="errors" role="tab" aria-selected="false">Błędy</button>
          <button class="tab-btn focus-ring px-3 py-2 text-[12px] font-medium rounded-lg border border-transparent hover:border-[var(--border)] hover:bg-[rgba(255,255,255,.04)] transition" data-tab="voice" role="tab" aria-selected="false">Voice / TTS</button>
          <button class="tab-btn focus-ring px-3 py-2 text-[12px] font-medium rounded-lg border border-transparent hover:border-[var(--border)] hover:bg-[rgba(255,255,255,.04)] transition" data-tab="logs" role="tab" aria-selected="false">Logi</button>
        </div>

        <div class="flex items-center gap-2">
          <div class="hidden sm:flex items-center gap-2">
            <span class="text-[11px] text-[color:var(--muted)]">Zaktualizowano</span>
            <span id="updatedAt" class="text-[12px] font-medium">—</span>
          </div>
          <span class="hidden md:inline text-[11px] text-[color:var(--muted)] border-l border-[var(--border)] pl-3">Projekt na desktop • 1440px</span>
        </div>
      </div>
    </section>

    <!-- Panels -->
    <main class="mt-3">

      <!-- Overview -->
      <section id="panel-overview" class="tab-panel fade-in" role="tabpanel">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-2">
          <div class="lg:col-span-8 glass rounded-xl border border-[var(--border)] p-3">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-[12px] font-semibold">Żądania w czasie</div>
                <div class="text-[11px] text-[color:var(--muted)]">Linia/obszar • subtelna siatka • tooltip po najechaniu</div>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-[11px] text-[color:var(--muted)]">p95</span>
                <span id="p95Hint" class="text-[11px] font-medium">—</span>
              </div>
            </div>
            <div class="mt-2 h-[240px]">
              <canvas id="chartRequests"></canvas>
            </div>
          </div>

          <div class="lg:col-span-4 grid grid-cols-1 gap-2">
            <div class="glass rounded-xl border border-[var(--border)] p-3">
              <div class="flex items-center justify-between">
                <div>
                  <div class="text-[12px] font-semibold">Rozkład błędów</div>
                  <div class="text-[11px] text-[color:var(--muted)]">Donut • wg klasy</div>
                </div>
                <span class="text-[11px] text-[color:var(--muted)]">24h</span>
              </div>
              <div class="mt-2 h-[200px]">
                <canvas id="chartErrorsDonut"></canvas>
              </div>
            </div>

            <div class="glass rounded-xl border border-[var(--border)] p-3">
              <div class="flex items-center justify-between">
                <div>
                  <div class="text-[12px] font-semibold">Użycie endpointów</div>
                  <div class="text-[11px] text-[color:var(--muted)]">Poziomy słupek • top 6</div>
                </div>
                <span class="text-[11px] text-[color:var(--muted)]">żądania</span>
              </div>
              <div class="mt-2 h-[200px]">
                <canvas id="chartEndpoints"></canvas>
              </div>
            </div>
          </div>

          <!-- Dev widgets -->
          <div class="lg:col-span-12 glass rounded-xl border border-[var(--border)] p-3">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-[12px] font-semibold">Widgety deweloperskie</div>
                <div class="text-[11px] text-[color:var(--muted)]">Kompaktowe sygnały operacyjne</div>
              </div>
              <div class="text-[11px] text-[color:var(--muted)]">brak backendu • symulacja</div>
            </div>
            <div class="mt-2 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-2">

              <div class="glass-strong rounded-xl border border-[var(--border)] p-3">
                <div class="flex items-center justify-between">
                  <div class="text-[11px] text-[color:var(--muted)]">WebSocket</div>
                  <span id="wsPill" class="text-[11px] px-2 py-0.5 rounded-full border border-[var(--border)]">—</span>
                </div>
                <div class="mt-1 flex items-end justify-between">
                  <div class="text-[14px] font-semibold" id="wsState">—</div>
                  <div class="text-[11px] text-[color:var(--muted)]" id="wsRtt">—</div>
                </div>
              </div>

              <div class="glass-strong rounded-xl border border-[var(--border)] p-3">
                <div class="flex items-center justify-between">
                  <div class="text-[11px] text-[color:var(--muted)]">Stan API</div>
                  <span id="apiPill" class="text-[11px] px-2 py-0.5 rounded-full border border-[var(--border)]">—</span>
                </div>
                <div class="mt-1 flex items-end justify-between">
                  <div class="text-[14px] font-semibold" id="apiHealth">—</div>
                  <div class="text-[11px] text-[color:var(--muted)]" id="apiOk">—</div>
                </div>
              </div>

              <div class="glass-strong rounded-xl border border-[var(--border)] p-3">
                <div class="flex items-center justify-between">
                  <div class="text-[11px] text-[color:var(--muted)]">Długość kolejki</div>
                  <span class="text-[11px] text-[color:var(--muted)]">zadania</span>
                </div>
                <div class="mt-1 flex items-end justify-between">
                  <div class="text-[14px] font-semibold" id="queueLen">—</div>
                  <div class="text-[11px]" id="queueDelta">—</div>
                </div>
              </div>

              <div class="glass-strong rounded-xl border border-[var(--border)] p-3">
                <div class="flex items-center justify-between">
                  <div class="text-[11px] text-[color:var(--muted)]">CPU / Pamięć</div>
                  <span class="text-[11px] text-[color:var(--muted)]">%</span>
                </div>
                <div class="mt-2 space-y-2">
                  <div>
                    <div class="flex items-center justify-between text-[11px]">
                      <span class="text-[color:var(--muted)]">CPU</span>
                      <span id="cpuVal" class="font-medium">—</span>
                    </div>
                    <div class="mt-1 h-2 rounded-full bg-black/20 border border-[var(--border)] overflow-hidden">
                      <div id="cpuBar" class="h-full rounded-full" style="width:0%; background: linear-gradient(90deg, rgba(56,189,248,.9), rgba(91,124,255,.95));"></div>
                    </div>
                  </div>
                  <div>
                    <div class="flex items-center justify-between text-[11px]">
                      <span class="text-[color:var(--muted)]">Pamięć</span>
                      <span id="memVal" class="font-medium">—</span>
                    </div>
                    <div class="mt-1 h-2 rounded-full bg-black/20 border border-[var(--border)] overflow-hidden">
                      <div id="memBar" class="h-full rounded-full" style="width:0%; background: linear-gradient(90deg, rgba(34,197,94,.9), rgba(56,189,248,.9));"></div>
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>

        </div>
      </section>

      <!-- Traffic -->
      <section id="panel-traffic" class="tab-panel hidden" role="tabpanel">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-2">
          <div class="lg:col-span-8 glass rounded-xl border border-[var(--border)] p-3">
            <div>
              <div class="text-[12px] font-semibold">Żądania w czasie</div>
              <div class="text-[11px] text-[color:var(--muted)]">Linia/obszar • trend + wariancja</div>
            </div>
            <div class="mt-2 h-[260px]">
              <canvas id="chartTraffic"></canvas>
            </div>
          </div>
          <div class="lg:col-span-4 glass rounded-xl border border-[var(--border)] p-3">
            <div>
              <div class="text-[12px] font-semibold">Intencje / endpointy</div>
              <div class="text-[11px] text-[color:var(--muted)]">Poziomy słupek • top endpointy</div>
            </div>
            <div class="mt-2 h-[260px]">
              <canvas id="chartTrafficEndpoints"></canvas>
            </div>
          </div>
        </div>
      </section>

      <!-- Latency -->
      <section id="panel-latency" class="tab-panel hidden" role="tabpanel">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-2">
          <div class="lg:col-span-8 glass rounded-xl border border-[var(--border)] p-3">
            <div>
              <div class="text-[12px] font-semibold">Opóźnienie w czasie</div>
              <div class="text-[11px] text-[color:var(--muted)]">Linia • średnia + pasmo p95</div>
            </div>
            <div class="mt-2 h-[260px]">
              <canvas id="chartLatency"></canvas>
            </div>
          </div>
          <div class="lg:col-span-4 glass rounded-xl border border-[var(--border)] p-3">
            <div>
              <div class="text-[12px] font-semibold">Koszyki opóźnień</div>
              <div class="text-[11px] text-[color:var(--muted)]">Słupek • rozkład (snapshot)</div>
            </div>
            <div class="mt-2 h-[260px]">
              <canvas id="chartLatencyBuckets"></canvas>
            </div>
          </div>
        </div>
      </section>

      <!-- Errors -->
      <section id="panel-errors" class="tab-panel hidden" role="tabpanel">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-2">
          <div class="lg:col-span-8 glass rounded-xl border border-[var(--border)] p-3">
            <div>
              <div class="text-[12px] font-semibold">Wskaźnik błędów w czasie</div>
              <div class="text-[11px] text-[color:var(--muted)]">Linia • % + tooltip</div>
            </div>
            <div class="mt-2 h-[260px]">
              <canvas id="chartErrorRate"></canvas>
            </div>
          </div>
          <div class="lg:col-span-4 glass rounded-xl border border-[var(--border)] p-3">
            <div>
              <div class="text-[12px] font-semibold">Rozkład błędów</div>
              <div class="text-[11px] text-[color:var(--muted)]">Donut • 4xx/5xx/timeout/limit</div>
            </div>
            <div class="mt-2 h-[260px]">
              <canvas id="chartErrorsDonut2"></canvas>
            </div>
          </div>
        </div>
      </section>

      <!-- Voice / TTS -->
      <section id="panel-voice" class="tab-panel hidden" role="tabpanel">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-2">
          <div class="lg:col-span-7 glass rounded-xl border border-[var(--border)] p-3">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="text-[12px] font-semibold">Voice / TTS — konfiguracja</div>
                <div class="text-[11px] text-[color:var(--muted)]">Pitch / prędkość • wybór modelu i głosu • test odsłuchu (przeglądarka)</div>
              </div>
              <div class="text-[11px] text-[color:var(--muted)]">bez backendu • zapis lokalny</div>
            </div>

            <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-2">
              <div class="glass-strong rounded-xl border border-[var(--border)] p-3">
                <div class="flex items-center justify-between">
                  <div class="text-[11px] text-[color:var(--muted)]">Pitch</div>
                  <div class="text-[11px] font-medium"><span id="pitchVal">1.00</span></div>
                </div>
                <input id="pitch" type="range" min="0.5" max="2" step="0.05" value="1" class="mt-2 w-full accent-[color:var(--neon)]" />
                <div class="mt-1 flex items-center justify-between text-[10px] text-[color:var(--muted)]">
                  <span>0.50</span><span>1.00</span><span>2.00</span>
                </div>
              </div>

              <div class="glass-strong rounded-xl border border-[var(--border)] p-3">
                <div class="flex items-center justify-between">
                  <div class="text-[11px] text-[color:var(--muted)]">Prędkość</div>
                  <div class="text-[11px] font-medium"><span id="speedVal">1.00</span></div>
                </div>
                <input id="speed" type="range" min="0.5" max="2" step="0.05" value="1" class="mt-2 w-full accent-[color:var(--neon)]" />
                <div class="mt-1 flex items-center justify-between text-[10px] text-[color:var(--muted)]">
                  <span>0.50</span><span>1.00</span><span>2.00</span>
                </div>
              </div>

              <div class="glass-strong rounded-xl border border-[var(--border)] p-3 sm:col-span-2">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                  <div>
                    <label class="text-[11px] text-[color:var(--muted)]" for="ttsModel">Model TTS</label>
                    <select id="ttsModel" class="mt-1 w-full bg-transparent text-[12px] font-medium focus-ring rounded-lg px-2 py-2 border border-[var(--border)]">
                      <option value="standard" selected>standard</option>
                      <option value="neural">neural</option>
                      <option value="studio">studio</option>
                      <option value="low-latency">low-latency</option>
                    </select>
                    <div class="mt-1 text-[10px] text-[color:var(--muted)]">UI-only: model to metadane do requestów</div>
                  </div>

                  <div>
                    <label class="text-[11px] text-[color:var(--muted)]" for="ttsVoice">Głos</label>
                    <select id="ttsVoice" class="mt-1 w-full bg-transparent text-[12px] font-medium focus-ring rounded-lg px-2 py-2 border border-[var(--border)]">
                      <option value="" selected>Ładowanie głosów…</option>
                    </select>
                    <div id="voiceHint" class="mt-1 text-[10px] text-[color:var(--muted)]">Wybór z Web Speech API (jeśli dostępne)</div>
                  </div>
                </div>
              </div>

              <div class="glass-strong rounded-xl border border-[var(--border)] p-3 sm:col-span-2">
                <label class="text-[11px] text-[color:var(--muted)]" for="ttsText">Tekst testowy</label>
                <textarea id="ttsText" rows="3" class="mt-1 w-full bg-transparent text-[12px] focus-ring rounded-lg px-3 py-2 border border-[var(--border)]" placeholder="Wpisz tekst do odsłuchu…">To jest test syntezy mowy. Sprawdź pitch, prędkość, model i głos.</textarea>

                <div class="mt-2 flex flex-wrap items-center gap-2">
                  <button id="ttsTest" class="glass rounded-xl px-3 py-2 text-[12px] font-medium border border-[var(--border)] hover:neon-ring transition-shadow focus-ring">Test (Speak)</button>
                  <button id="ttsStop" class="glass rounded-xl px-3 py-2 text-[12px] font-medium border border-[var(--border)] hover:neon-ring transition-shadow focus-ring">Stop</button>
                  <button id="ttsReset" class="glass rounded-xl px-3 py-2 text-[12px] font-medium border border-[var(--border)] hover:neon-ring transition-shadow focus-ring">Reset</button>

                  <span id="ttsStatus" class="text-[11px] text-[color:var(--muted)]">—</span>
                </div>
              </div>
            </div>
          </div>

          <div class="lg:col-span-5 glass rounded-xl border border-[var(--border)] p-3">
            <div>
              <div class="text-[12px] font-semibold">Podgląd konfiguracji (JSON)</div>
              <div class="text-[11px] text-[color:var(--muted)]">Kopiuj do narzędzi / zgłoszeń / porównań</div>
            </div>
            <pre id="ttsPreview" class="mt-2 text-[11px] leading-5 p-3 rounded-xl border border-[var(--border)] bg-black/10 overflow-auto tiny-scroll"></pre>

            <div class="mt-2 flex items-center justify-between">
              <div class="text-[11px] text-[color:var(--muted)]">Wskazówka</div>
              <button id="ttsCopy" class="glass rounded-xl px-3 py-2 text-[12px] font-medium border border-[var(--border)] hover:neon-ring transition-shadow focus-ring">Kopiuj JSON</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Logs -->
      <section id="panel-logs" class="tab-panel hidden" role="tabpanel">
        <div class="glass rounded-xl border border-[var(--border)] p-3">
          <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-2">
            <div>
              <div class="text-[12px] font-semibold">Logi / Panel deweloperski</div>
              <div class="text-[11px] text-[color:var(--muted)]">Filtr poziomu • wyszukiwanie • auto-przewijanie</div>
            </div>

            <div class="flex flex-wrap items-center gap-2">
              <div class="flex items-center gap-1 glass rounded-xl border border-[var(--border)] p-1">
                <button class="lvl-btn focus-ring text-[12px] px-3 py-1.5 rounded-lg border border-transparent hover:border-[var(--border)]" data-level="all">Wszystkie</button>
                <button class="lvl-btn focus-ring text-[12px] px-3 py-1.5 rounded-lg border border-transparent hover:border-[var(--border)]" data-level="info">Info</button>
                <button class="lvl-btn focus-ring text-[12px] px-3 py-1.5 rounded-lg border border-transparent hover:border-[var(--border)]" data-level="warn">Ostrz.</button>
                <button class="lvl-btn focus-ring text-[12px] px-3 py-1.5 rounded-lg border border-transparent hover:border-[var(--border)]" data-level="error">Błędy</button>
              </div>

              <div class="glass rounded-xl border border-[var(--border)] px-2 py-1 flex items-center gap-2">
                <svg class="size-4 text-[color:var(--muted)]" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M21 21l-4.3-4.3" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
                  <path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="1.7"/>
                </svg>
                <input id="logSearch" class="bg-transparent text-[12px] w-56 focus-ring rounded-lg px-2 py-1" placeholder="Szukaj w wiadomości/źródle…" />
              </div>

              <label class="glass rounded-xl border border-[var(--border)] px-3 py-2 flex items-center gap-2 text-[12px]">
                <input id="autoScroll" type="checkbox" class="accent-[color:var(--neon)]" checked />
                Auto-przewijanie
              </label>

              <button id="clearLogs" class="glass rounded-xl px-3 py-2 text-[12px] font-medium border border-[var(--border)] hover:neon-ring transition-shadow focus-ring">Wyczyść</button>
            </div>
          </div>

          <div class="mt-3 border border-[var(--border)] rounded-xl overflow-hidden">
            <div class="grid grid-cols-12 gap-0 text-[11px] text-[color:var(--muted)] bg-black/10 border-b border-[var(--border)]">
              <div class="col-span-3 px-3 py-2">Znacznik czasu</div>
              <div class="col-span-1 px-3 py-2">Poziom</div>
              <div class="col-span-2 px-3 py-2">Źródło</div>
              <div class="col-span-6 px-3 py-2">Wiadomość</div>
            </div>

            <div id="logScroller" class="max-h-[420px] overflow-auto tiny-scroll">
              <div id="logRows" class="divide-y divide-[rgba(255,255,255,.06)]"></div>
            </div>
          </div>

          <div class="mt-2 flex items-center justify-between text-[11px] text-[color:var(--muted)]">
            <div><span id="logCount">0</span> wierszy</div>
            <div class="flex items-center gap-2">
              <span class="inline-flex items-center gap-2"><span class="size-2 rounded-full" style="background: var(--good)"></span>info</span>
              <span class="inline-flex items-center gap-2"><span class="size-2 rounded-full" style="background: var(--warn)"></span>ostrzeż.</span>
              <span class="inline-flex items-center gap-2"><span class="size-2 rounded-full" style="background: var(--bad)"></span>błąd</span>
            </div>
          </div>
        </div>
      </section>

    </main>

    <footer class="mt-4 text-[11px] text-[color:var(--muted)] flex items-center justify-between">
      <div class="truncate">Panel administracyjny analityki • glassmorphism + subtelny neon • bez auth/backendu</div>
      <div class="hidden sm:block">v0.1 • dane symulowane</div>
    </footer>
  </div>

  <script>
    // ---------- Utilities ----------
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const clamp = (v, a, b) => Math.max(a, Math.min(b, v));

    function fmtInt(n){
      return new Intl.NumberFormat(undefined).format(Math.round(n));
    }
    function fmt1(n){
      return (Math.round(n*10)/10).toFixed(1);
    }
    function nowTime(){
      return new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    }
    function isoShort(d){
      const pad = (x)=>String(x).padStart(2,'0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    // ---------- Theme ----------
    const themeToggle = $('#themeToggle');
    const themeLabel = $('#themeLabel');
    const themeIcon = $('#themeIcon');

    function setTheme(mode){
      const html = document.documentElement;
      if(mode === 'light') html.classList.remove('dark');
      else html.classList.add('dark');
      localStorage.setItem('theme', mode);
      const dark = html.classList.contains('dark');
      themeLabel.textContent = dark ? 'Ciemny' : 'Jasny';
      // icon: moon in dark, sun in light
      themeIcon.innerHTML = dark
        ? '<path d="M21 12.6A8.4 8.4 0 1 1 11.4 3a6.6 6.6 0 1 0 9.6 9.6Z" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/>'
        : '<path d="M12 18a6 6 0 1 0-6-6 6 6 0 0 0 6 6Z" stroke="currentColor" stroke-width="1.7"/><path d="M12 2v2" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/><path d="M12 20v2" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/><path d="M4.93 4.93l1.41 1.41" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/><path d="M17.66 17.66l1.41 1.41" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/><path d="M2 12h2" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/><path d="M20 12h2" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/><path d="M4.93 19.07l1.41-1.41" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/><path d="M17.66 6.34l1.41-1.41" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>';

      // Repaint charts for better contrast when theme flips
      requestAnimationFrame(() => {
        Object.values(charts).forEach(ch => ch?.update('none'));
      });
    }

    const savedTheme = localStorage.getItem('theme');
    setTheme(savedTheme || 'dark');

    themeToggle.addEventListener('click', () => {
      const dark = document.documentElement.classList.contains('dark');
      setTheme(dark ? 'light' : 'dark');
    });

    // ---------- Tabs ----------
    const tabs = $$('.tab-btn');
    const panels = {
      overview: $('#panel-overview'),
      traffic: $('#panel-traffic'),
      latency: $('#panel-latency'),
      errors: $('#panel-errors'),
      voice: $('#panel-voice'),
      logs: $('#panel-logs')
    };

    function setActiveTab(tab){
      tabs.forEach(btn => {
        const active = btn.dataset.tab === tab;
        btn.setAttribute('aria-selected', active ? 'true' : 'false');
        btn.classList.toggle('bg-[rgba(255,255,255,.06)]', active);
        btn.classList.toggle('border-[var(--border)]', active);
        btn.classList.toggle('neon-ring', active);
      });
      Object.entries(panels).forEach(([k, el]) => {
        el.classList.toggle('hidden', k !== tab);
        if(k === tab){
          el.classList.remove('fade-in');
          void el.offsetWidth;
          el.classList.add('fade-in');
        }
      });
      ensureChartsForTab(tab);

      // Auto-scroll only when in logs tab
      if(tab === 'logs' && $('#autoScroll').checked){
        scrollLogsToBottom();
      }
    }

    tabs.forEach(btn => btn.addEventListener('click', () => setActiveTab(btn.dataset.tab)));

    // ---------- Chart configuration helpers ----------
    const charts = {}; // id -> Chart

    function cssVar(name){
      return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    }

    function baseChartOptions(){
      const muted = cssVar('--muted');
      const border = cssVar('--border');
      return {
        responsive: true,
        maintainAspectRatio: false,
        animation: { duration: 650, easing: 'easeOutQuart' },
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(10,16,32,.85)',
            titleColor: '#EAF0FF',
            bodyColor: '#EAF0FF',
            borderColor: 'rgba(255,255,255,.14)',
            borderWidth: 1,
            padding: 10,
            displayColors: false
          }
        },
        scales: {
          x: {
            grid: { color: border, drawBorder: false },
            ticks: { color: muted, maxTicksLimit: 6, font: { size: 11 } }
          },
          y: {
            grid: { color: border, drawBorder: false },
            ticks: { color: muted, font: { size: 11 } }
          }
        }
      };
    }

    // ---------- Simulated data model ----------
    const state = {
      range: '24h',
      series: null,
      endpoints: null,
      errors: null,
      logs: [],
      logLevel: 'all',
      logSearch: '',
      tts: {
        pitch: 1,
        speed: 1,
        model: 'standard',
        voiceURI: ''
      }
    };

    function genTimeseries(range){
      const now = new Date();
      let points = 24, stepMin = 60;
      if(range === '6h'){ points = 24; stepMin = 15; }
      if(range === '1h'){ points = 20; stepMin = 3; }

      const labels = [];
      const req = [];
      const latency = [];
      const p95 = [];
      const errRate = [];

      const baseReq = range === '24h' ? 4200 : range === '6h' ? 1250 : 320;
      const baseLat = 140;

      for(let i=points-1; i>=0; i--){
        const d = new Date(now.getTime() - i*stepMin*60*1000);
        const label = range === '24h'
          ? d.toLocaleTimeString([], {hour:'2-digit'})
          : d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        labels.push(label);

        const wave = Math.sin((points-i)/4) * 0.18 + Math.cos((points-i)/9) * 0.10;
        const noise = (Math.random()-0.5) * 0.22;
        const vReq = baseReq * (1 + wave + noise);
        const vLat = baseLat * (1 + (Math.cos((points-i)/5) * 0.12) + (Math.random()-0.5)*0.18);
        const vP95 = vLat * (1.35 + Math.random()*0.18);
        const vErr = clamp(0.7 + (Math.sin((points-i)/6)*0.25) + (Math.random()-0.5)*0.25, 0.05, 4.5);

        req.push(Math.round(vReq));
        latency.push(Math.round(vLat));
        p95.push(Math.round(vP95));
        errRate.push(Number(fmt1(vErr)));
      }

      return { labels, req, latency, p95, errRate };
    }

    function genEndpoints(){
      const names = [
        'POST /v1/nlu/parse',
        'POST /v1/chat/turn',
        'GET /v1/health',
        'POST /v1/tts/speak',
        'POST /v1/db/query',
        'POST /v1/embedding'
      ];
      const vals = names.map((_, i) => Math.round(800 + (6-i)*240 + Math.random()*220));
      return { names, vals };
    }

    function genErrorDistribution(){
      const labels = ['4xx', '5xx', 'Timeout', 'Limit'];
      const data = [
        Math.round(45 + Math.random()*20),
        Math.round(20 + Math.random()*12),
        Math.round(10 + Math.random()*10),
        Math.round(6 + Math.random()*8)
      ];
      return { labels, data };
    }

    function deriveKPIs(series){
      const totalReq = series.req.reduce((a,b)=>a+b,0);
      const sessions = Math.round(260 + Math.random()*180);
      const avgLat = Math.round(series.latency.reduce((a,b)=>a+b,0)/series.latency.length);
      const avgErr = Number(fmt1(series.errRate.reduce((a,b)=>a+b,0)/series.errRate.length));
      // status heuristic
      let status = 'działa';
      if(avgErr > 2.2 || avgLat > 220) status = 'degradacja';
      if(avgErr > 4.0 || avgLat > 320) status = 'awaria';
      return { totalReq, sessions, avgLat, avgErr, status };
    }

    function randTrend(goodWhenDown=false){
      const delta = (Math.random()*2.4 - 1.2);
      const up = delta >= 0;
      const sign = up ? '▲' : '▼';
      const color = goodWhenDown ? (up ? 'var(--bad)' : 'var(--good)') : (up ? 'var(--good)' : 'var(--bad)');
      return { text: `${sign} ${Math.abs(delta).toFixed(1)}%`, color };
    }

    function pill(el, text, color){
      el.textContent = text;
      el.style.color = color;
      el.style.borderColor = 'rgba(255,255,255,.12)';
      el.style.background = 'rgba(255,255,255,.05)';
    }

    // ---------- Chart creation per tab (lazy) ----------
    function createRequestsChart(){
      const ctx = $('#chartRequests');
      if(!ctx) return;
      const neon = cssVar('--neon');
      const border = cssVar('--border');

      charts.requests = new Chart(ctx, {
        type: 'line',
        data: {
          labels: state.series.labels,
          datasets: [{
            label: 'Żądania',
            data: state.series.req,
            borderColor: neon,
            backgroundColor: 'rgba(91,124,255,.18)',
            fill: true,
            tension: 0.32,
            pointRadius: 0,
            borderWidth: 2
          }]
        },
        options: {
          ...baseChartOptions(),
          scales: {
            x: { grid: { color: border, drawBorder: false }, ticks: { color: cssVar('--muted'), maxTicksLimit: 7, font: { size: 11 } } },
            y: { grid: { color: border, drawBorder: false }, ticks: { color: cssVar('--muted'), callback: v => fmtInt(v), font: { size: 11 } } }
          },
          plugins: {
            ...baseChartOptions().plugins,
            tooltip: {
              ...baseChartOptions().plugins.tooltip,
              callbacks: {
                label: (ctx) => ` ${fmtInt(ctx.parsed.y)} żądań`
              }
            }
          }
        }
      });
    }

    function createEndpointsChart(canvasId, key){
      const ctx = $(canvasId);
      if(!ctx) return;
      const border = cssVar('--border');
      const muted = cssVar('--muted');

      charts[key] = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: state.endpoints.names,
          datasets: [{
            label: 'Żądania',
            data: state.endpoints.vals,
            borderWidth: 0,
            borderRadius: 8,
            backgroundColor: state.endpoints.names.map((_, i) => i % 2 === 0 ? 'rgba(56,189,248,.55)' : 'rgba(91,124,255,.55)')
          }]
        },
        options: {
          ...baseChartOptions(),
          indexAxis: 'y',
          scales: {
            x: { grid: { color: border, drawBorder: false }, ticks: { color: muted, font:{size:11}, callback: v => fmtInt(v) } },
            y: { grid: { display:false }, ticks: { color: muted, font:{size:11} } }
          },
          plugins: {
            ...baseChartOptions().plugins,
            tooltip: {
              ...baseChartOptions().plugins.tooltip,
              callbacks: {
                label: (ctx) => ` ${fmtInt(ctx.parsed.x)} żądań`
              }
            }
          }
        }
      });
    }

    function createErrorDonut(canvasId, key){
      const ctx = $(canvasId);
      if(!ctx) return;
      const muted = cssVar('--muted');

      charts[key] = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: state.errors.labels,
          datasets: [{
            data: state.errors.data,
            backgroundColor: [
              'rgba(56,189,248,.65)',
              'rgba(239,68,68,.65)',
              'rgba(245,158,11,.65)',
              'rgba(91,124,255,.55)'
            ],
            borderColor: 'rgba(255,255,255,.08)',
            borderWidth: 1,
            hoverOffset: 6
          }]
        },
        options: {
          responsive:true,
          maintainAspectRatio:false,
          cutout:'68%',
          animation:{ duration: 750, easing:'easeOutQuart' },
          plugins:{
            legend:{
              display:true,
              position:'bottom',
              labels:{ color: muted, boxWidth:10, boxHeight:10, padding: 12, font:{ size: 11 } }
            },
            tooltip:{
              backgroundColor: 'rgba(10,16,32,.85)',
              borderColor: 'rgba(255,255,255,.14)',
              borderWidth: 1,
              titleColor: '#EAF0FF',
              bodyColor: '#EAF0FF',
              padding: 10,
              displayColors: true
            }
          }
        }
      });
    }

    function createTrafficChart(){
      const ctx = $('#chartTraffic');
      if(!ctx) return;
      const neon2 = cssVar('--neon2');

      charts.traffic = new Chart(ctx, {
        type: 'line',
        data: {
          labels: state.series.labels,
          datasets: [{
            label: 'Żądania',
            data: state.series.req,
            borderColor: neon2,
            backgroundColor: 'rgba(56,189,248,.14)',
            fill: true,
            tension: 0.32,
            pointRadius: 0,
            borderWidth: 2
          }]
        },
        options: {
          ...baseChartOptions(),
          plugins: {
            ...baseChartOptions().plugins,
            tooltip: {
              ...baseChartOptions().plugins.tooltip,
              callbacks: { label: (ctx) => ` ${fmtInt(ctx.parsed.y)} żądań` }
            }
          }
        }
      });
    }

    function createLatencyChart(){
      const ctx = $('#chartLatency');
      if(!ctx) return;
      const neon = cssVar('--neon');
      const border = cssVar('--border');
      charts.latency = new Chart(ctx, {
        type: 'line',
        data: {
          labels: state.series.labels,
          datasets: [
            {
              label:'p95',
              data: state.series.p95,
              borderColor: 'rgba(245,158,11,.70)',
              backgroundColor: 'rgba(245,158,11,.10)',
              fill: true,
              tension: 0.28,
              pointRadius: 0,
              borderWidth: 2
            },
            {
              label:'średnia',
              data: state.series.latency,
              borderColor: neon,
              backgroundColor: 'rgba(91,124,255,.08)',
              fill: false,
              tension: 0.28,
              pointRadius: 0,
              borderWidth: 2
            }
          ]
        },
        options: {
          ...baseChartOptions(),
          plugins: {
            ...baseChartOptions().plugins,
            tooltip: {
              ...baseChartOptions().plugins.tooltip,
              callbacks: {
                label: (ctx) => ` ${ctx.dataset.label.toUpperCase()}: ${fmtInt(ctx.parsed.y)} ms`
              }
            }
          },
          scales: {
            x: { grid: { color: border, drawBorder: false }, ticks: { color: cssVar('--muted'), maxTicksLimit: 7, font: { size: 11 } } },
            y: { grid: { color: border, drawBorder: false }, ticks: { color: cssVar('--muted'), font: { size: 11 }, callback: v => `${v}ms` } }
          }
        }
      });
    }

    function createLatencyBuckets(){
      const ctx = $('#chartLatencyBuckets');
      if(!ctx) return;
      const border = cssVar('--border');
      const muted = cssVar('--muted');
      const buckets = ['<100', '100-150', '150-200', '200-300', '300+'];
      const data = [
        Math.round(16 + Math.random()*6),
        Math.round(28 + Math.random()*8),
        Math.round(22 + Math.random()*7),
        Math.round(12 + Math.random()*5),
        Math.round(5 + Math.random()*4)
      ];
      charts.latBuckets = new Chart(ctx, {
        type:'bar',
        data:{
          labels: buckets,
          datasets:[{
            label:'%',
            data,
            borderRadius: 8,
            backgroundColor: buckets.map((_, i) => i < 2 ? 'rgba(34,197,94,.55)' : i < 4 ? 'rgba(245,158,11,.55)' : 'rgba(239,68,68,.55)')
          }]
        },
        options:{
          ...baseChartOptions(),
          plugins:{
            ...baseChartOptions().plugins,
            tooltip:{
              ...baseChartOptions().plugins.tooltip,
              callbacks:{ label: (ctx)=> ` ${ctx.parsed.y}%` }
            }
          },
          scales:{
            x:{ grid:{ display:false }, ticks:{ color: muted, font:{size:11} } },
            y:{ grid:{ color: border, drawBorder:false }, ticks:{ color: muted, font:{size:11}, callback: v => `${v}%` }, suggestedMax: 40 }
          }
        }
      });
    }

    function createErrorRateChart(){
      const ctx = $('#chartErrorRate');
      if(!ctx) return;
      const border = cssVar('--border');
      charts.errRate = new Chart(ctx, {
        type:'line',
        data:{
          labels: state.series.labels,
          datasets:[{
            label:'Wskaźnik błędów',
            data: state.series.errRate,
            borderColor: 'rgba(239,68,68,.80)',
            backgroundColor: 'rgba(239,68,68,.10)',
            fill: true,
            tension: 0.32,
            pointRadius: 0,
            borderWidth: 2
          }]
        },
        options:{
          ...baseChartOptions(),
          scales:{
            x: { grid: { color: border, drawBorder:false }, ticks: { color: cssVar('--muted'), maxTicksLimit: 7, font:{size:11} } },
            y: { grid: { color: border, drawBorder:false }, ticks: { color: cssVar('--muted'), font:{size:11}, callback: v => `${v}%` }, suggestedMax: 5 }
          },
          plugins:{
            ...baseChartOptions().plugins,
            tooltip:{
              ...baseChartOptions().plugins.tooltip,
              callbacks:{ label: (ctx)=> ` ${fmt1(ctx.parsed.y)}%` }
            }
          }
        }
      });
    }

    function ensureChartsForTab(tab){
      // Create only once per tab to avoid sizing issues on hidden canvases.
      if(tab === 'overview'){
        if(!charts.requests) createRequestsChart();
        if(!charts.errorsDonut) createErrorDonut('#chartErrorsDonut', 'errorsDonut');
        if(!charts.endpoints) createEndpointsChart('#chartEndpoints', 'endpoints');
      }
      if(tab === 'traffic'){
        if(!charts.traffic) createTrafficChart();
        if(!charts.trafficEndpoints) createEndpointsChart('#chartTrafficEndpoints', 'trafficEndpoints');
      }
      if(tab === 'latency'){
        if(!charts.latency) createLatencyChart();
        if(!charts.latBuckets) createLatencyBuckets();
      }
      if(tab === 'errors'){
        if(!charts.errRate) createErrorRateChart();
        if(!charts.errorsDonut2) createErrorDonut('#chartErrorsDonut2', 'errorsDonut2');
      }

      // Resize update after tab becomes visible
      setTimeout(()=>{
        Object.values(charts).forEach(ch => ch?.resize());
      }, 50);
    }

    // ---------- Voice / TTS ----------
    const TTS_STORAGE_KEY = 'adminPanel.tts';

    function supportsSpeech(){
      return !!(window.speechSynthesis && window.SpeechSynthesisUtterance);
    }

    function getVoiceList(){
      try{ return window.speechSynthesis?.getVoices?.() || []; }catch(e){ return []; }
    }

    function formatVoiceLabel(v){
      const lang = v.lang ? ` • ${v.lang}` : '';
      const local = v.localService ? ' • local' : '';
      const def = v.default ? ' • domyślny' : '';
      return `${v.name}${lang}${local}${def}`;
    }

    function loadTTSSettings(){
      try{
        const raw = localStorage.getItem(TTS_STORAGE_KEY);
        if(!raw) return;
        const obj = JSON.parse(raw);
        if(typeof obj.pitch === 'number') state.tts.pitch = clamp(obj.pitch, 0.5, 2);
        if(typeof obj.speed === 'number') state.tts.speed = clamp(obj.speed, 0.5, 2);
        if(typeof obj.model === 'string') state.tts.model = obj.model;
        if(typeof obj.voiceURI === 'string') state.tts.voiceURI = obj.voiceURI;
      }catch(e){}
    }

    function saveTTSSettings(){
      try{
        localStorage.setItem(TTS_STORAGE_KEY, JSON.stringify(state.tts));
      }catch(e){}
    }

    function applyTTSUIFromState(){
      const pitch = $('#pitch');
      const speed = $('#speed');
      const model = $('#ttsModel');
      if(pitch) pitch.value = String(state.tts.pitch);
      if(speed) speed.value = String(state.tts.speed);
      if(model) model.value = state.tts.model;
      $('#pitchVal').textContent = Number(state.tts.pitch).toFixed(2);
      $('#speedVal').textContent = Number(state.tts.speed).toFixed(2);
      updateTTSPreview();
    }

    function updateTTSPreview(){
      const preview = {
        model: state.tts.model,
        voiceURI: state.tts.voiceURI || null,
        pitch: Number(state.tts.pitch.toFixed(2)),
        speed: Number(state.tts.speed.toFixed(2)),
        sampleText: ($('#ttsText')?.value || '').slice(0, 160)
      };
      const el = $('#ttsPreview');
      if(el) el.textContent = JSON.stringify(preview, null, 2);
    }

    function populateVoices(){
      const sel = $('#ttsVoice');
      const hint = $('#voiceHint');
      if(!sel) return;

      if(!supportsSpeech()){
        sel.innerHTML = '<option value="" selected>Brak wsparcia Web Speech API</option>';
        if(hint) hint.textContent = 'Twoja przeglądarka nie udostępnia speechSynthesis.';
        state.tts.voiceURI = '';
        updateTTSPreview();
        return;
      }

      const voices = getVoiceList();
      if(!voices.length){
        sel.innerHTML = '<option value="" selected>Ładowanie głosów…</option>';
        if(hint) hint.textContent = 'Lista głosów może pojawić się po chwili (speechSynthesis.onvoiceschanged).';
        return;
      }

      // Try to keep selection if possible
      const current = state.tts.voiceURI;
      sel.innerHTML = ['<option value="">(systemowy / domyślny)</option>']
        .concat(voices.map(v => `<option value="${escapeHtml(v.voiceURI)}">${escapeHtml(formatVoiceLabel(v))}</option>`))
        .join('');

      // Restore selection
      if(current){
        const opt = Array.from(sel.options).find(o => o.value === current);
        if(opt) sel.value = current;
      }

      // Auto pick pl voice if nothing chosen
      if(!sel.value){
        const pl = voices.find(v => (v.lang || '').toLowerCase().startsWith('pl'));
        if(pl){
          sel.value = pl.voiceURI;
          state.tts.voiceURI = pl.voiceURI;
          saveTTSSettings();
        }
      }

      if(hint){
        const chosen = voices.find(v => v.voiceURI === sel.value);
        hint.textContent = chosen
          ? `Wybrano: ${chosen.name} (${chosen.lang || '—'})`
          : 'Użycie głosu domyślnego systemu.';
      }
      updateTTSPreview();
    }

    function setTTSStatus(text, tone='muted'){
      const el = $('#ttsStatus');
      if(!el) return;
      const map = {
        muted: cssVar('--muted'),
        good: cssVar('--good'),
        warn: cssVar('--warn'),
        bad: cssVar('--bad')
      };
      el.textContent = text;
      el.style.color = map[tone] || map.muted;
    }

    function speakTest(){
      if(!supportsSpeech()){
        setTTSStatus('Brak wsparcia Web Speech API w tej przeglądarce.', 'warn');
        return;
      }
      const text = ($('#ttsText')?.value || '').trim();
      if(!text){
        setTTSStatus('Wpisz tekst testowy.', 'warn');
        return;
      }

      try{ window.speechSynthesis.cancel(); }catch(e){}

      const u = new SpeechSynthesisUtterance(text);
      u.pitch = Number(state.tts.pitch);
      u.rate = Number(state.tts.speed);

      const voices = getVoiceList();
      const v = state.tts.voiceURI ? voices.find(x => x.voiceURI === state.tts.voiceURI) : null;
      if(v) u.voice = v;

      u.onstart = () => setTTSStatus('Odtwarzanie…', 'good');
      u.onend = () => setTTSStatus('Zakończono.', 'muted');
      u.onerror = () => setTTSStatus('Błąd odtwarzania.', 'bad');

      window.speechSynthesis.speak(u);
    }

    function stopSpeak(){
      if(!supportsSpeech()) return;
      try{ window.speechSynthesis.cancel(); }catch(e){}
      setTTSStatus('Zatrzymano.', 'muted');
    }

    function bindTTSControls(){
      if(!$('#panel-voice')) return;

      // Inputs
      $('#pitch')?.addEventListener('input', (e)=>{
        state.tts.pitch = Number(e.target.value);
        $('#pitchVal').textContent = state.tts.pitch.toFixed(2);
        saveTTSSettings();
        updateTTSPreview();
      });
      $('#speed')?.addEventListener('input', (e)=>{
        state.tts.speed = Number(e.target.value);
        $('#speedVal').textContent = state.tts.speed.toFixed(2);
        saveTTSSettings();
        updateTTSPreview();
      });
      $('#ttsModel')?.addEventListener('change', (e)=>{
        state.tts.model = e.target.value;
        saveTTSSettings();
        updateTTSPreview();
      });
      $('#ttsVoice')?.addEventListener('change', (e)=>{
        state.tts.voiceURI = e.target.value;
        saveTTSSettings();
        populateVoices();
      });
      $('#ttsText')?.addEventListener('input', ()=>{
        updateTTSPreview();
      });

      // Actions
      $('#ttsTest')?.addEventListener('click', speakTest);
      $('#ttsStop')?.addEventListener('click', stopSpeak);
      $('#ttsReset')?.addEventListener('click', ()=>{
        state.tts.pitch = 1;
        state.tts.speed = 1;
        state.tts.model = 'standard';
        state.tts.voiceURI = '';
        saveTTSSettings();
        applyTTSUIFromState();
        populateVoices();
        setTTSStatus('Zresetowano ustawienia.', 'muted');
      });
      $('#ttsCopy')?.addEventListener('click', async ()=>{
        try{
          await navigator.clipboard.writeText($('#ttsPreview')?.textContent || '');
          setTTSStatus('Skopiowano JSON.', 'good');
        }catch(e){
          setTTSStatus('Nie udało się skopiować (brak uprawnień).', 'warn');
        }
      });

      // Voices lifecycle
      if(supportsSpeech()){
        try{
          window.speechSynthesis.onvoiceschanged = () => populateVoices();
        }catch(e){}
      }

      // First paint
      applyTTSUIFromState();
      populateVoices();
      setTTSStatus('Gotowe.', 'muted');
    }

    // ---------- Logs ----------
    const SOURCES = ['NLU', 'API', 'DB', 'TTS', 'Frontend'];

    function randFrom(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

    function genLog(){
      const level = Math.random() < 0.75 ? 'info' : (Math.random() < 0.65 ? 'warn' : 'error');
      const source = randFrom(SOURCES);
      const msgPool = {
        info: [
          'Żądanie zakończone',
          'Trafienie w cache',
          'Token odświeżony',
          'Model rozgrzany',
          'Przetworzono paczkę'
        ],
        warn: [
          'Wykryto skok opóźnień',
          'Ponawianie wywołania upstream',
          'Limiter zbliża się do progu',
          'Częściowa degradacja: włączono fallback'
        ],
        error: [
          'Timeout upstream',
          'Błąd połączenia z DB',
          'Nieobsłużony wyjątek w handlerze',
          'WebSocket niespodziewanie rozłączony'
        ]
      };
      const msg = randFrom(msgPool[level]);
      const extra = Math.random() < 0.45 ? ` • trace=${Math.random().toString(16).slice(2,10)}` : '';
      return {
        ts: new Date(),
        level,
        source,
        message: msg + extra
      };
    }

    function seedLogs(n=120){
      state.logs = [];
      const now = Date.now();
      for(let i=n; i>0; i--){
        const l = genLog();
        l.ts = new Date(now - i * (Math.random()*6500 + 900));
        state.logs.push(l);
      }
    }

    function levelBadge(level){
      const colors = {
        info: 'var(--good)',
        warn: 'var(--warn)',
        error: 'var(--bad)'
      };
      const bg = {
        info: 'rgba(34,197,94,.12)',
        warn: 'rgba(245,158,11,.12)',
        error: 'rgba(239,68,68,.12)'
      };
      const label = level === 'warn' ? 'ostrzeż.' : (level === 'error' ? 'błąd' : 'info');
      return `<span class="inline-flex items-center justify-center w-full max-w-[66px] px-2 py-0.5 rounded-full border" style="border-color: rgba(255,255,255,.12); background:${bg[level]}; color:${colors[level]};">${label}</span>`;
    }

    function sourcePill(source){
      const map = {
        API: 'rgba(91,124,255,.16)',
        NLU: 'rgba(56,189,248,.16)',
        DB: 'rgba(139,92,246,.16)',
        TTS: 'rgba(245,158,11,.16)',
        Frontend: 'rgba(34,197,94,.16)'
      };
      return `<span class="inline-flex items-center px-2 py-0.5 rounded-full border" style="border-color: rgba(255,255,255,.10); background:${map[source] || 'rgba(255,255,255,.08)'};">${source}</span>`;
    }

    function applyLogActiveButton(){
      $$('.lvl-btn').forEach(b => {
        const active = b.dataset.level === state.logLevel;
        b.classList.toggle('bg-[rgba(255,255,255,.06)]', active);
        b.classList.toggle('border-[var(--border)]', active);
        b.classList.toggle('neon-ring', active);
      });
    }

    function filteredLogs(){
      const q = state.logSearch.trim().toLowerCase();
      return state.logs.filter(l => {
        const levelOk = state.logLevel === 'all' ? true : l.level === state.logLevel;
        const qOk = !q ? true : (l.message.toLowerCase().includes(q) || l.source.toLowerCase().includes(q));
        return levelOk && qOk;
      });
    }

    function renderLogs(){
      const rows = $('#logRows');
      const list = filteredLogs();
      $('#logCount').textContent = String(list.length);

      // Cap rendered rows for perf; keep newest
      const cap = 240;
      const view = list.slice(-cap);
      rows.innerHTML = view.map(l => {
        const ts = isoShort(l.ts);
        return `
          <div class="grid grid-cols-12 gap-0 text-[12px]">
            <div class="col-span-3 px-3 py-2 text-[color:var(--muted)]">${ts}</div>
            <div class="col-span-1 px-3 py-2">${levelBadge(l.level)}</div>
            <div class="col-span-2 px-3 py-2 text-[12px]">${sourcePill(l.source)}</div>
            <div class="col-span-6 px-3 py-2 font-medium">${escapeHtml(l.message)}</div>
          </div>
        `;
      }).join('');

      if($('#autoScroll').checked){
        scrollLogsToBottom();
      }
    }

    function scrollLogsToBottom(){
      const sc = $('#logScroller');
      sc.scrollTop = sc.scrollHeight;
    }

    function escapeHtml(s){
      return s
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#039;');
    }

    // Logs controls
    $$('.lvl-btn').forEach(btn => btn.addEventListener('click', () => {
      state.logLevel = btn.dataset.level;
      applyLogActiveButton();
      renderLogs();
    }));
    $('#logSearch').addEventListener('input', (e)=>{
      state.logSearch = e.target.value;
      renderLogs();
    });
    $('#clearLogs').addEventListener('click', ()=>{
      state.logs = [];
      renderLogs();
    });

    // ---------- Refresh / range ----------
    const rangeSel = $('#range');
    rangeSel.addEventListener('change', () => {
      state.range = rangeSel.value;
      refreshAll(true);
    });

    $('#refresh').addEventListener('click', () => refreshAll(true));

    function destroyAllCharts(){
      Object.values(charts).forEach(ch => { try{ ch.destroy(); }catch(e){} });
      for(const k of Object.keys(charts)) delete charts[k];
    }

    function refreshAll(rebuildCharts=false){
      state.series = genTimeseries(state.range);
      state.endpoints = genEndpoints();
      state.errors = genErrorDistribution();

      const k = deriveKPIs(state.series);
      $('#kpiRequests').textContent = fmtInt(k.totalReq);
      $('#kpiSessions').textContent = fmtInt(k.sessions);
      $('#kpiLatency').textContent = fmtInt(k.avgLat);
      $('#kpiErrorRate').textContent = fmt1(k.avgErr);

      const tR = randTrend(false);
      const tS = randTrend(false);
      const tL = randTrend(true);
      const tE = randTrend(true);

      pill($('#trendRequests'), tR.text, tR.color);
      pill($('#trendSessions'), tS.text, tS.color);
      pill($('#trendLatency'), tL.text, tL.color);
      pill($('#trendErrorRate'), tE.text, tE.color);

      // status
      const statusText = k.status;
      $('#kpiStatus').textContent = statusText;
      const statusPill = $('#kpiStatusPill');
      const statusColor = statusText === 'działa' ? cssVar('--good') : statusText === 'degradacja' ? cssVar('--warn') : cssVar('--bad');
      statusPill.textContent = statusText.toUpperCase();
      statusPill.style.color = statusColor;
      statusPill.style.background = statusText === 'działa' ? 'rgba(34,197,94,.12)' : statusText === 'degradacja' ? 'rgba(245,158,11,.12)' : 'rgba(239,68,68,.12)';

      // p95 hint
      const p95Avg = state.series.p95.reduce((a,b)=>a+b,0)/state.series.p95.length;
      $('#p95Hint').textContent = `${fmtInt(p95Avg)} ms`;

      // dev widgets
      const wsOk = Math.random() > 0.08;
      const wsRtt = Math.round(28 + Math.random()*40);
      $('#wsState').textContent = wsOk ? 'połączono' : 'ponawianie';
      $('#wsRtt').textContent = `${wsRtt} ms RTT`;
      $('#wsPill').textContent = wsOk ? 'OK' : 'WARN';
      $('#wsPill').style.color = wsOk ? cssVar('--good') : cssVar('--warn');
      $('#wsPill').style.background = wsOk ? 'rgba(34,197,94,.12)' : 'rgba(245,158,11,.12)';

      const apiOk = Math.random() > 0.06;
      const health = apiOk ? 'zdrowe' : 'degradacja';
      $('#apiHealth').textContent = health;
      $('#apiOk').textContent = apiOk ? '200 OK' : 'skoki 5xx';
      $('#apiPill').textContent = apiOk ? 'OK' : 'WARN';
      $('#apiPill').style.color = apiOk ? cssVar('--good') : cssVar('--warn');
      $('#apiPill').style.background = apiOk ? 'rgba(34,197,94,.12)' : 'rgba(245,158,11,.12)';

      const qLen = Math.round(4 + Math.random()*28);
      $('#queueLen').textContent = fmtInt(qLen);
      const qDelta = (Math.random()*6 - 3);
      $('#queueDelta').textContent = `${qDelta>=0?'▲':'▼'} ${Math.abs(qDelta).toFixed(0)} w 5m`;
      $('#queueDelta').style.color = qDelta >= 0 ? cssVar('--warn') : cssVar('--good');

      const cpu = clamp(18 + Math.random()*62, 0, 100);
      const mem = clamp(26 + Math.random()*58, 0, 100);
      $('#cpuVal').textContent = `${Math.round(cpu)}%`;
      $('#memVal').textContent = `${Math.round(mem)}%`;
      $('#cpuBar').style.width = `${cpu}%`;
      $('#memBar').style.width = `${mem}%`;

      // timestamps
      $('#updatedAt').textContent = nowTime();

      // charts
      if(rebuildCharts){
        destroyAllCharts();
      }

      // If charts exist, update them; otherwise they will be created lazily when tab is opened.
      if(charts.requests){
        charts.requests.data.labels = state.series.labels;
        charts.requests.data.datasets[0].data = state.series.req;
        charts.requests.update();
      }
      if(charts.traffic){
        charts.traffic.data.labels = state.series.labels;
        charts.traffic.data.datasets[0].data = state.series.req;
        charts.traffic.update();
      }
      if(charts.latency){
        charts.latency.data.labels = state.series.labels;
        charts.latency.data.datasets[0].data = state.series.p95;
        charts.latency.data.datasets[1].data = state.series.latency;
        charts.latency.update();
      }
      if(charts.errRate){
        charts.errRate.data.labels = state.series.labels;
        charts.errRate.data.datasets[0].data = state.series.errRate;
        charts.errRate.update();
      }

      // endpoint charts
      const endpointCharts = ['endpoints', 'trafficEndpoints'];
      endpointCharts.forEach(k => {
        const ch = charts[k];
        if(!ch) return;
        ch.data.labels = state.endpoints.names;
        ch.data.datasets[0].data = state.endpoints.vals;
        ch.update();
      });

      // donut charts
      const donutCharts = ['errorsDonut', 'errorsDonut2'];
      donutCharts.forEach(k => {
        const ch = charts[k];
        if(!ch) return;
        ch.data.labels = state.errors.labels;
        ch.data.datasets[0].data = state.errors.data;
        ch.update();
      });
    }

    // ---------- Clock ----------
    function tickClock(){
      const d = new Date();
      $('#clock').textContent = d.toLocaleString([], {weekday:'short', hour:'2-digit', minute:'2-digit'});
    }
    setInterval(tickClock, 1000 * 15);
    tickClock();

    // ---------- Initialize ----------
    function init(){
      state.series = genTimeseries(state.range);
      state.endpoints = genEndpoints();
      state.errors = genErrorDistribution();
      seedLogs(160);

      // Defaults
      state.logLevel = 'all';
      applyLogActiveButton();
      renderLogs();

      // Initial KPIs + (lazy charts for Overview)
      refreshAll(false);
      setActiveTab('overview');

      // Simulated log stream
      setInterval(() => {
        if(state.logs.length > 900) state.logs.splice(0, 250);
        state.logs.push(genLog());
        // Only rerender if user is on logs or auto-scroll is on
        const logsVisible = !panels.logs.classList.contains('hidden');
        if(logsVisible || $('#autoScroll').checked) renderLogs();
      }, 2800);

      // Gentle periodic refresh for widgets/KPIs
      setInterval(() => {
        refreshAll(false);
      }, 12000);
    }

    init();
  </script>
</body>
</html>
